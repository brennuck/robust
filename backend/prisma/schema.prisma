// Prisma Schema for Robust Workout App
// Using PostgreSQL with Neon

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String?  @unique
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  pushTokens      PushToken[]
  workouts        Workout[]
  workoutTemplates WorkoutTemplate[]
  personalRecords PersonalRecord[]

  @@map("users")
}

model PushToken {
  id        String   @id @default(cuid())
  token     String
  platform  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([userId, platform])
  @@map("push_tokens")
}

// Exercise Library - shared across all users
model Exercise {
  id           String   @id @default(cuid())
  name         String
  muscleGroup  String   // chest, back, shoulders, arms, legs, core, cardio
  equipment    String   // barbell, dumbbell, machine, cable, bodyweight, other
  instructions String?
  imageUrl     String?
  isCustom     Boolean  @default(false)
  createdById  String?  // null for system exercises
  createdAt    DateTime @default(now())

  // Relations
  workoutExercises  WorkoutExercise[]
  templateExercises TemplateExercise[]
  personalRecords   PersonalRecord[]

  @@unique([name, createdById])
  @@map("exercises")
}

// Completed Workouts
model Workout {
  id          String    @id @default(cuid())
  name        String
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  duration    Int?      // in seconds
  notes       String?
  
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  exercises WorkoutExercise[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workouts")
}

// Exercises within a workout
model WorkoutExercise {
  id       String @id @default(cuid())
  order    Int
  notes    String?
  restTime Int?   // rest time in seconds between sets

  workout    Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId  String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])
  exerciseId String

  sets WorkoutSet[]

  @@map("workout_exercises")
}

// Individual sets
model WorkoutSet {
  id         String  @id @default(cuid())
  order      Int
  weight     Float?  // in user's preferred unit
  reps       Int?
  duration   Int?    // for timed exercises (in seconds)
  distance   Float?  // for cardio (in user's preferred unit)
  isWarmup   Boolean @default(false)
  isDropset  Boolean @default(false)
  isFailure  Boolean @default(false)
  isPR       Boolean @default(false)
  completed  Boolean @default(false)

  workoutExercise   WorkoutExercise @relation(fields: [workoutExerciseId], references: [id], onDelete: Cascade)
  workoutExerciseId String

  @@map("workout_sets")
}

// Workout Templates (routines)
model WorkoutTemplate {
  id        String   @id @default(cuid())
  name      String
  notes     String?
  color     String?  // hex color for UI
  
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  exercises TemplateExercise[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workout_templates")
}

// Exercises within a template
model TemplateExercise {
  id           String @id @default(cuid())
  order        Int
  targetSets   Int    @default(3)
  targetReps   String @default("8-12") // can be "8-12", "5", "AMRAP"
  restTime     Int?   // rest time in seconds
  notes        String?

  template   WorkoutTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  templateId String
  exercise   Exercise        @relation(fields: [exerciseId], references: [id])
  exerciseId String

  @@map("template_exercises")
}

// Personal Records
model PersonalRecord {
  id        String   @id @default(cuid())
  weight    Float
  reps      Int
  estimated1RM Float? // calculated e1RM
  achievedAt DateTime

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])
  exerciseId String

  createdAt DateTime @default(now())

  @@map("personal_records")
}
